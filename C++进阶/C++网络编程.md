# C++网络编程

## 1.概念

- 网络设计模式

  - B/S
    - broswer-浏览器->客户端
      - html
      - css
      - js
    - server->服务器
    - 优势：
      - 跨平台
      - 开发成本低
    - 缺点：
      - 网络通信的时候，必须要使用http协议
        - http/https->应用层协议
      - 不能在磁盘缓存或者从磁盘加载大量数据
  - C/S
    - client->桌面应用程序->Qt
      - QQ
      - 迅雷
      - 微信
    - server->服务器
    - 特点：
      - 优点：
        - 使用协议可以随便选择
        - 可以在本地缓存或加载大量数据
      - 缺点：
        - 研发成本高
          - 在不同的平台开发不同的客户端版本
          - 

- 服务器:

  - 硬件：配置比较高的主机
    - 买阿里云，百度云服务器
  - 软件：
    - 有一台主机，运行了一个进程，能够处理网络协议，称这台主机是一个服务器
      - nginx
  - 服务器开发：
    - 工作不是去开发web服务器，
    - 我们做的工作：
      - 在一台装有服务器的主机上，开发应用程序
        - 应用程序：
          - 斗地主
          - 网盘：文件服务器

- IP和端口

  - IP地址分类

    - 公网IP	
      - 可以访问Internet,公网IP是唯一的
      - 局域网IP
        - 小的网络，比如一个路由器对应家里的网段
          - 192.168.1xxxx
        - 在这个小的网络中的IP是唯一的
        - 在网络的主机可以互相通信，如果局域网和外网连接，那么通过居于网IP也可以连接外网

  - IP协议

    - IPV4-"Internet Protocol Version 4"
      - 现在应用很广泛的协议
      - IP地址的点分十进制字符串
        - 192.168.1.100
      - 本质是一个整形数，4字节，32位
        - 通过3个点分成4分，每份一个字节
          - 字节的取值范围0-255
          - 最大的IP地址
          - 255.255.255.255
      - 可用的IP地址：
        - 2的32次方-1
      - 现在IPv4的IP地址不够用，在2011年就分配完了
    - IPV6-"Internet Protocol Version 6"
      - 现在应用不是很广泛，将来主推的一种网络协议
      - 本质也是整形数，16字节，128bit
      - IP地址表示：
        - 分为8份，每份2字节
        - `fe80::020c::29ff::fe40`
        - 2 的128次方-1
        - 实现物联网，非常简单

  - 相关的linux命令

    ```
    #查看IP地址
    #linux
    $ ifconfig
    ens 33网卡名
    inet addr:后面是ipv4的IP地址
    inet6 addr:后面是iPv6的IP地址
    
    $ipconfig
    
    # 测试两台主机之间是否可用通信
    ping IP地址
    
    
    
    ping 域名
    
    
    只要是192.168.x.x格式都是局域网IP
    公网IP：11.13.45.67
    买百度云都会给公网IP
    ```

    

    127.0.0.1

    代表当前主机的IP，进行本地测试，假设，当前主机没有在一个网络环境中， 想用在当前主机进行网络测试，使用这个IP表示本机的IP地址

  - 端口

    ```shell
    #1.端口的本质？
    无符号短整型数 ->unsigned short
    #2.端口取值范围？
    1.可以有多少个端口：2的16次方
    2.取值范围：0-65535
    #3.端口的作用？
    定位某台主机上运行的某一个进程
    # 在电脑上运行了微信和QQ，小明给我的微信法消息，电脑上的微信就收到了消息，为什么？
    -运行的qq和微信在启动的时候都绑定了不同的端口
    -小明给我的微信发送数据
    	-需要知道我的IP地址->定位我电脑
    	-如何定位电脑中的某一个进程呢？--->通过端口
    	
    #4.如何给自己编写的应用程序分配端口？
    - 0 端口一般不用
    - 1-1024:系统使用的
    - 1024-5000:系统预装的程序/一些常用的协议使用
    - 5001-65535:留给用于自定义的端口
    
    #5.所有的进程都必须要有端口吗？
    所有的程序都必须要有端口吗?
    通讯的进程都需要端口
    绑定端口
    -bind()
    
    ```

  - ip和端口的使用

    ```shell
    #通过IP定位网络环境中的主机，通过端口定位主机上的进程
    #比如通过浏览器进行网络服务器访问
    #服务器
    
    #b/s ->协议http -> 使用的端口是80,https协议端口 -> 443
    #如果服务器使用的就是协议的默认端口，访问的时候端口是可以省略不写的
    http://www.baidu.com:80
    https://www.baidu.com:443
    
    http://192.168.1.100:9999
    
    #域名：特殊的字符串，通过这个字符串就可以访问到web服务器了
    #ip为什么要和域名关联?-->方便记忆网站地址
    #为什么？
    	-域名需要先申请，然后需要和web服务器和外网IP进行绑定
    	-绑定成功之后，才能通过域名访问到Web服务器->连接dns服务器->查询域名和IP的对应关系，->得到了域名对应的IP地址->通过IP地址访问web服务器
    ```

- OSI/ISO网络分层模型

  > OSI(Open System Interconnect),开放式互联.一般都叫OSI参考模型,是ISO(国际标准化组织)在1985年研究的网络互联模型

  ```shell
  上层
  |
  |七层模型		四层模型
  |
  |应用层
  |表示层		应用层http/ftp/ssh/ftps
  |会话层
  --------------------
  |传输层		传输层	tcp/udp
  --------------------
  |网络层		网络层	ip协议->ipv4/ipv6
  --------------------
  |数据链路层		网络接口层 以太网帧协议
  底层 物理层
  ```

  

## 2.协议格式

- 常见协议

  - TCP协议-> 传输层协议

    ![image-20250117161306292](C:\Users\86135\AppData\Roaming\Typora\typora-user-images\image-20250117161306292.png)

  - UDP协议->传输层协议
  - IP协议



![image-20250118104125960](C:\Users\86135\AppData\Roaming\Typora\typora-user-images\image-20250118104125960.png)

```shell
#两台主机A,B
1.A给B发送字符串,需要封装
2.封装是由操作系统或者调用的API自动完成的,程序员无需关心
3.如果程序员需要封装数据,一般是在应用层做处理,应用层数据可封装也可以不封装

数据"hello.world",在应用层进行发送
	1.在应用层对这个字符串封装(可选,程序猿做的)
	2.数据往下走->传输层->根据协议对数据打包
	3.数据往下走->网络层->根据协议格式打包数据
	4.数据往下走->网络接口层->根据协议格式打包数据,以太网帧协议
	5.数据通过网口发送给B
	
B接收数据,拆包
	1.网络接口层->根据协议格式拆包->以太网帧
	2.得到了网络层的包->拆包
	3.传输层包->拆包
	4.应用层的包->拆包/不拆包
	5.应用层如果使用协议封装了数据继续拆包,如果没有封装得到了"hello,world"   
	
	
程序猿只需要处理应用层,应用层一下 ,不需要我们处理
```

## socket编程

> 远景研究规划局资助加利福尼亚大学伯克利分校的研究组研发.目的是讲TCP/IP协议相关软件以知道UNIX类系统中.
> 不断完善,最终形成

```c
套接字通信就是网络通信,和语言没有关系
//1.套接字是什么?
1.套接字是一套网络通信的接口,这个接口中封装了传输层的协议(tcp/udp)
2.接口就是api,也就是一套函数


//2.socket(插座),套接字通信的组成部分?
socket本意是插座
1.服务器端,插座的作用
	-被动接受连接的角色,不会主动发起连接的
	-绑定IP和端口,这样客户端才能进行连接
	
	
2.客户端
	-主动发起连接的角色,连接服务器
	-连接服务器需要地址:
		-IP+端口

//3.怎么用?->所有编程语言的通信流程都是固定的
--服务器有通信流程
--客户端有通信流程

//4.套接字通信过程中数据要使用网络字节序
字节序:字符在内存中的存储顺序,单位是字节





//4.套接字通信过程中数据要使用网络字节符
    字节序:字符在内存中的存储顺序,单位是字节
    字节序分类:
			-网络字节序
            -主机字节序
                
	char-> 1字节
	int ->4字节
	内存低地址位 -> 内存高地址位
//5.字符串有没有字节序问题?
	没有字节序问题
	若干个独立的字符
                
//6.为什么网络传输要用大端?
	这是一个标准,跨主机通信,不同的主机使用的默认字节序不一样,安装本地默认字节序发送和解析数据有可能会乱,因此要有个标准
```

### 字节序

> 在各种计算机体系结构中,对于字节\字等的存储机制有所不同,因而引发了计算机通信领域中一个很重要的问题,即通信

- 概念

  - Little-Endian
    - 小端,也称主机字节序
    - 在内存的低地址位,存储数据 低位字节,在内存的高地址位存储数据的高位字节
      - 低低,高高
    - pc机数据都是小端存储,跟cpu架构有关系
  - Big-Endian
    - 大端,也称之为网络字节序
    - 在内存的低地址位,存储数据的高位字节,在内存的高地址位存储数据的低位字节
      - 低高,高低
    - 网络通信的是偶要使用大端的字节序

- 字节序举例

  ```
  //高地址位,低地址位
  
  
  
  
  
  
  ```

- 函数

  ```c
  //网络通信的时候,IP和端口都需要用大端模式
  //默认我们使用的IP和端口在本地是小端存储,在通信的时候需要转换
  //IP(ipv4)->int->32bit
  //端口(unsgined short) -> 16bit
  
  //h -> host ->主机
  //n -> net -> 网络
  //s -> unsigned short
  //l -> int
  #include<arpa/inet.h>
  //主机字节序转换为网络字节序
  uint16_t htons(uint16_t hostshort); //端口
  uint32_t htonl(uint32_t hostlong); //IP地址(ipv4)
  
  //网络字节序转换为主机字节序
  uint16_t ntohs(uint16_t netshort)
  uint32_t ntohl(uint32_t netlong);
  ```







### 3.2 IP地址转换

```c
//支持ipv4和ipv6格式的地址
#include <arpa/inet.h>//套接字通信只需要包含这个头文件就可以了
//p-> 主机字节序的字符串类型的IP地址
//将主机字节序的字符串类型的IP -> 大端的整形数
int inet_pton(int af,const char *src, void *dst);
参数:
	- af:地址族协议
        	- AF_INET:使用ipv4的网络协议
            - AF_INET6:使用ipv6的网络协议
	- src

const char *inet_ntop(int af,const void *src, char *dst socklen_t size);
```





### 3.3 