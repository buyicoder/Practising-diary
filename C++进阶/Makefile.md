# Makefile	

## Makefile文件和Cmake文件

### 1>什么是Makefile

```
用于工程项目管理的一个文本文件，文件名为Makefile的文本文件
Makefile可以大写，也可以消磁额，一般Makefile首字母使用大写
如果Makefile和makefile两个文件都存在，默认使用小写的

make这个指令在/usr/bin 中
如果没有下载一下就好了


```

### 3>Makefile的用途

```
描述了整个工程的编译、链接规则
软件项目的自动化编译，相当于给软件编译写一份脚本
```

### 4>学习Makefile 的必要性

```
Linux/Unix环境下开发的必备技能
系统架构师、项目经理的核心技能
研究开源项目、Linux内核原码的必需品
加深对底层软件构造系统及过程的理解
```

### 5>如何学习Makefile

1、理论基础

```
软件的构造过程、程序的编译和链接：预处理 --> 编译 -->汇编 -->链接
面向依赖的思想：
依赖一个.cpp文件的程序
可执行程序  <--

```

2、项目编程基础

```
C++语言基础
C语言基础
多文件原码管理、头文件包含、函数声明与定义
```

### 6>Makefile的工作过程

```
Makefile本身是面向依赖进行编写的
本质上一步就可以生成可执行程序，但是，由于在生成可执行程序时，可能会有多个文件进行参与，后期其它文件可能要进行更改，更改后，会影响到可执行程序的执行，其他没有更改的文件
```

分开的编译过程

-E -S -c ==一定要注意是小写的c！！！！！！==



```
#makefile中的注释是以#开头
#语法格式：
#目标：依赖
#       通过依赖生辰目标的指令
#注意：指令前面必须使用一个tab键隔开，不能使用多个空格顶过来


hello:hello.o
        g++ hello.o -o hello

hello.o:hello.s
        g++ -c hello.s -o hello.o

hello.s:hello.i
        g++ -S hello.i -o hello.s

hello.i:hello.cpp
        g++ -E hello.cpp -o hello.i                         
```

4、执行Makefile文件

```
make --->默认找到Makefile中的第一个目标开始执行
make 目标
```



### 8>makefile的语法规则

1、规则

构成Makefile的基本单元，构成依赖关系的核心部件

其它内容可以看做为规则的服务

2、变量

类似于C++中的宏，使用变量：\$(变量名)或者 \$(变量名)

3、条件执行

根据某一变量的值来控制make执行或者忽略Makefile的某一部分

4、函数

文本处理函数：字符串的替换、查找、过滤等待

文件名的处理：读取文件/目录名、前后缀等待

5、注释

Makefile中的注释，是以#号开头

### 9>规则

1、规则的构成



all:hello



3、目标详解

1）默认目标

```
一个Makefile里面可以有多个目标，一般会选择第一个当作默认目标
耶尔就是make默认执行的目标
```

2）多目标

一个规则中可以有多个目标，多个目标具有相同的生成命令和依赖文件

3）多规则目标

一个目标可以有多个生成命令和依赖文件

4）伪目标

```
并不是一个真正的文件，可以看做是一个标签
无依赖
伪目标

eg:
	
```

4、目标依赖

1）文件时间戳

```
根据时间戳来判断目标是否要进行更新
所有文件都更改过，则对所有文件进行编译，生成可执行程序
在上次make之后修改过的cpp文件，会被重新编译
在上次make只写过修改过的头文件，依赖该头文件的目标依赖也会重新编译
```

2）模式匹配

```
%  --->通配符匹配
$@ --->目标
$^ --->依赖
$< --->
```

5、命令

```
1)命令的组成
	由shell命令组成，以tab键开头
2)命令的执行
	每条命令，make会开一个进程
	每条命令执行完，make会检测返回命令返回码
	如果成功，继续执行
	如果返回失败，终止规则并退出
	
3)并发执行命令
	make -j4 ------>表示开辟4个线程执行
	time make ----->执行时显示时间
```



## 10>变量

```
变量定义：变量名=变量值
变量的赋值
	追加赋值： +=
	条件赋值： ?=如果之前没有值就赋值，如果有就不赋值
	
```

变量的分类

```
立即展开变量
	使用:=操作符进行赋值
	在解析阶段直接赋值常量字符串
延迟展开变量
	使用=操作符进行赋值
	将最后一次赋值的结果给变量名使用
注意事项
	一般在目标、目标依赖中使用立即展开赋值
	在命令中一般
```

## 11>条件执行

1、关键字

```
ifeq、else、endif
ifneq、else、endif
```





### 12>总结

执行过程

进入编译目录，执行make命令

依赖关系解析阶段

命令执行阶段



依赖解析阶段

机械Makefile，建立依赖关系树

控制解析过程，引入Makefile，变量展开、条件执行

生成依赖关系网



命令执行阶段

```
把解析生成的依赖关系树加载到内存
按依赖关系，按顺序生成这些文件
再次编译make会检测文件的时间戳，判断是否过期
	如果无过期，在不在编译
	如果文件有更新，则依赖该文件的所有依赖关系上的目标都会重新编译
```

4、make执行结果

```
make 的退出码
	0 成功执行
	1 表示允许错误，退出	
```





